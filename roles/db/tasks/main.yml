---
# =========================================================
# 공통: PyMySQL 설치
#  - community.mysql 모듈 필수
# =========================================================
- name: Install PyMySQL for Ansible MySQL modules (master/standby)
  dnf:
    name: python3-PyMySQL
    state: present
  when: "'db_backup' not in group_names"

# =========================================================
# DB 서버 설치 (Master / Standby)
# =========================================================
- name: Install MySQL server (master/standby)
  dnf:
    name: mysql-server
    state: present
  when: "'db_backup' not in group_names"

# =========================================================
# Backup 노드: 클라이언트만 설치
# =========================================================
- name: Install MySQL client only (backup)
  dnf:
    name: mysql
    state: present
  when: "'db_backup' in group_names"

# =========================================================
# MySQL 서비스 활성화
# =========================================================
- name: Enable and start MySQL (master/standby)
  systemd:
    name: mysqld
    enabled: yes
    state: started
  when: "'db_backup' not in group_names"

# =========================================================
# MySQL 설정 배포
# =========================================================
- name: Deploy MySQL config (master/standby)
  template:
    src: my.cnf.j2
    dest: /etc/my.cnf
    owner: root
    group: root
    mode: '0644'
  notify: Restart MySQL
  when: "'db_backup' not in group_names"

# =========================================================
# 설정 변경 즉시 반영
# =========================================================
- name: Flush handlers (restart mysqld if needed)
  meta: flush_handlers
  when: "'db_backup' not in group_names"

# =========================================================
# Master / Standby 공통: root 비밀번호 설정 (1회)
#  - DB-A, DB-S 동일한 root 정책 유지
# =========================================================
- name: Set MySQL root password (master/standby, once)
  command: mysqladmin -u root password "{{ mysql_root_password }}"
  args:
    creates: /root/.mysql_root_pw_set
  when: "'db_backup' not in group_names"

- name: Mark root password set (master/standby)
  file:
    path: /root/.mysql_root_pw_set
    state: touch
  when: "'db_backup' not in group_names"

# =========================================================
# Master 전용: Replication 사용자 생성
# =========================================================
- name: Create replication user (master only)
  community.mysql.mysql_user:
    login_unix_socket: /var/lib/mysql/mysql.sock
    login_user: root
    login_password: "{{ mysql_root_password }}"
    name: "{{ repl_user }}"
    password: "{{ repl_password }}"
    host: "192.168.10.%"
    priv: "*.*:REPLICATION SLAVE"
    state: present
  when: "'db_master' in group_names"

# =========================================================
# Master 전용: 애플리케이션 DB 생성
# =========================================================
- name: Create application database (master only)
  community.mysql.mysql_db:
    login_unix_socket: /var/lib/mysql/mysql.sock
    login_user: root
    login_password: "{{ mysql_root_password }}"
    name: "{{ app_db }}"
    state: present
  when: "'db_master' in group_names"

# =========================================================
# Master 전용: 애플리케이션 사용자 생성
# =========================================================
- name: Create application user (master only)
  community.mysql.mysql_user:
    login_unix_socket: /var/lib/mysql/mysql.sock
    login_user: root
    login_password: "{{ mysql_root_password }}"
    name: "{{ app_user }}"
    password: "{{ app_password }}"
    host: "192.168.10.%"
    priv: "{{ app_db }}.*:ALL"
    state: present
  when: "'db_master' in group_names"

# =========================================================
# Replication (Master → Standby)
# =========================================================
- import_tasks: replication.yml

  # =========================================================
# Master 전용: Backup 사용자 생성 (read-only)
# =========================================================
- name: Create backup user (master only)
  community.mysql.mysql_user:
    login_unix_socket: /var/lib/mysql/mysql.sock
    login_user: root
    login_password: "{{ mysql_root_password }}"
    name: "{{ backup_user }}"
    password: "{{ backup_password }}"
    host: "{{ hostvars['db-b']['ansible_host'] | default('192.168.10.40') }}"
    priv: "*.*:SELECT,LOCK TABLES,SHOW VIEW"
    state: present
  when: "'db_master' in group_names"
# =========================================================
# Backup (DB-B)
# =========================================================
- import_tasks: backup.yml
  when: "'db_backup' in group_names"

#=======================================================
# add proxy include
#======================================================

- name: Proxy tasks
  ansible.builtin.include_tasks: proxy.yml
  when: "'proxy' in group_names"

- name: DB tasks (master/standby/backup)
  ansible.builtin.include_tasks: mariadb.yml
  when:
    - "'db_master' in group_names or 'db_standby' in group_names or 'db_backup' in group_names"


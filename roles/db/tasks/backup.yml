---
# =========================================================
# Backup 노드: 백업 디렉터리 생성
# =========================================================
- name: Create backup directory
  file:
    path: "{{ backup_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0750'

# =========================================================
# Backup 스크립트 배포
# =========================================================
- name: Deploy MySQL backup script
  copy:
    dest: /usr/local/bin/mysql_backup.sh
    mode: '0750'
    content: |
      #!/bin/bash
      set -e

      DATE=$(date +%Y%m%d)
      BACKUP_DIR="{{ backup_dir }}"
      FILE="$BACKUP_DIR/db-${DATE}.sql.gz"

      mysqldump \
        -h {{ hostvars['db-a']['ansible_host'] }} \
        -u {{ backup_user }} \
        -p'{{ backup_password }}' \
        --single-transaction \
        --routines \
        --events \
        --triggers \
        --all-databases \
      | gzip > "$FILE"

      # Remove old backups
      find "$BACKUP_DIR" -type f -mtime +{{ backup_retention_days }} -delete

# =========================================================
# Cron 등록 (매일 02:00)
# =========================================================
- name: Register daily backup cron
  cron:
    name: "MySQL daily backup"
    minute: "0"
    hour: "2"
    user: root
    job: "/usr/local/bin/mysql_backup.sh"

